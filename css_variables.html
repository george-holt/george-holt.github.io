<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CSS Variables Usage</title>

    <style>
      :root {
        --font-family: "Roboto", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        --font-size-base: 16px;
        --spacing: 16px;
        --radius: 8px;
        --border: 1px solid #e5e7eb;
      }
      body {
        font-family: var(--font-family);
        font-size: var(--font-size-base);
        line-height: 1.5;
        margin: 0;
        color: #111827;
        background: #ffffff;
      }
      .container {
        max-width: 960px;
        margin: 0 auto;
        padding: calc(var(--spacing) * 1.25) var(--spacing);
      }
      h1 {
        font-size: 1.75rem;
        margin: 0 0 var(--spacing) 0;
      }
      .meta {
        color: #6b7280;
        margin-bottom: calc(var(--spacing) * 1.25);
      }
      table {
        width: 100%;
        border-collapse: collapse;
        border: var(--border);
        border-radius: var(--radius);
        overflow: hidden;
      }
      thead th {
        background: #f9fafb;
        text-align: left;
        font-weight: 600;
        border-bottom: var(--border);
        padding: 10px 12px;
      }
      tbody td {
        border-bottom: var(--border);
        padding: 10px 12px;
        vertical-align: top;
      }
      tbody tr:last-child td {
        border-bottom: none;
      }
      code {
        background: #f3f4f6;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 2px 6px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 0.95em;
      }
      .note {
        margin-top: calc(var(--spacing) * 0.75);
        color: #6b7280;
        font-size: 0.95rem;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Custom CSS Variables and Reference Counts</h1>
      <div class="meta" id="meta">Scanning...</div>
      <table aria-label="CSS variables usage table">
        <thead>
          <tr>
            <th style="width: 55%">Variable</th>
            <th style="width: 15%">References</th>
            <th style="width: 30%">Defined In</th>
          </tr>
        </thead>
        <tbody id="results"></tbody>
      </table>
      <p class="note">
        Counts include <code>var(--name)</code> usages across
        <code>index.html</code>, <code>engineering_responsibilities.html</code>,
        and <code>css/custom.css</code>. Definitions are parsed from
        <code>:root</code>
        blocks in the HTML files.
      </p>
    </div>

    <script>
      (function () {
        const sources = [
          { path: "index.html?v=1.0", label: "index.html" },
          {
            path: "engineering_responsibilities.html?v=1.0",
            label: "engineering_responsibilities.html",
          },
          { path: "css/custom.css?v=1.0", label: "css/custom.css" },
        ];

        const resultsBody = document.getElementById("results");
        const meta = document.getElementById("meta");

        function escapeRegExp(string) {
          return string.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
        }

        function parseRootVariables(text) {
          const vars = new Map(); // name -> { value, files: Set<string> }
          const rootRegex = /:root\s*\{([\s\S]*?)\}/g;
          let rootMatch;
          while ((rootMatch = rootRegex.exec(text))) {
            const block = rootMatch[1];
            const varRegex = /--([a-zA-Z0-9_-]+)\s*:\s*([^;]+);/g;
            let m;
            while ((m = varRegex.exec(block))) {
              const name = m[1].trim();
              const value = m[2].trim();
              if (!vars.has(name)) {
                vars.set(name, { value, files: new Set() });
              }
            }
          }
          return vars;
        }

        function countReferences(textsByFile, varNames) {
          const counts = new Map(); // name -> total count
          const fileMap = new Map(); // name -> Map(fileLabel -> count)
          for (const name of varNames) {
            counts.set(name, 0);
            fileMap.set(name, new Map());
            const pattern = new RegExp(
              "var\\(--" + escapeRegExp(name) + "\\b",
              "g"
            );
            for (const { label, text } of textsByFile) {
              const c = (text.match(pattern) || []).length;
              if (c > 0) {
                counts.set(name, counts.get(name) + c);
                fileMap.get(name).set(label, c);
              }
            }
          }
          return { counts, fileMap };
        }

        async function fetchText(path) {
          const res = await fetch(path, { cache: "no-store" });
          if (!res.ok) throw new Error("HTTP " + res.status + " for " + path);
          return res.text();
        }

        async function main() {
          try {
            const texts = await Promise.all(
              sources.map((s) =>
                fetchText(s.path)
                  .then((t) => ({ label: s.label, text: t }))
                  .catch(() => ({ label: s.label, text: "" }))
              )
            );

            // Collect variable definitions from HTML sources only
            const definitions = new Map(); // name -> { value, files: Set<string> }
            for (const { label, text } of texts) {
              if (!label.endsWith(".html")) continue;
              const vars = parseRootVariables(text);
              for (const [name, info] of vars.entries()) {
                if (!definitions.has(name)) {
                  definitions.set(name, {
                    value: info.value,
                    files: new Set(),
                  });
                }
                definitions.get(name).files.add(label);
              }
            }

            const varNames = Array.from(definitions.keys()).sort((a, b) =>
              a.localeCompare(b)
            );

            const { counts } = countReferences(texts, varNames);

            // Render table
            resultsBody.innerHTML = "";
            for (const name of varNames) {
              const def = definitions.get(name);
              const total = counts.get(name) || 0;
              const filesDefined = Array.from(def.files).join(", ");
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td><code>--${name}</code></td>
                <td>${total}</td>
                <td>${filesDefined}</td>
              `;
              resultsBody.appendChild(tr);
            }

            meta.textContent = `Found ${varNames.length} variables across ${sources.length} files.`;
          } catch (err) {
            // Fail quietly in production: do not surface errors to end users
            meta.textContent = "";
            // eslint-disable-next-line no-console
            console.error("CSS variables scan error:", err);
          }
        }

        main();
      })();
    </script>
  </body>
</html>
